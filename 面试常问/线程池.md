

![image-20220310124819176](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310124819176.png)![image-20220310125129595](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310125129595.png)

![image-20220310125408051](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310125408051.png)

问题：初始化多少线程，过多的话一开启就崩？队列要多长，过长的话内存不够，系统崩了？队列满了怎么办？

![image-20220310125615876](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310125615876.png)

![image-20220310125901653](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310125901653.png)

![image-20220310130110884](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310130110884.png)

![image-20220310131615380](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310131615380.png)

![image-20220310131751257](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310131751257.png)

![image-20220310131836393](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310131836393.png)![image-20220310183305882](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310183305882.png)

![image-20220310132110457](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310132110457.png)

![image-20220310132321950](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310132321950.png)

![image-20220310132802615](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310132802615.png)

![image-20220310132833025](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310132833025.png)

![image-20220310132957094](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310132957094.png)

![image-20220310133128657](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310133128657.png)

把删除的注释掉后，发现插入也不成功，说明同步移交队列没有存储元素的能力，只是来做生产者消费者1对1的缓冲作用![image-20220310133159500](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310133159500.png)

由上可以看出，线程池的3种队列：基于数组的有界队列，基于链表的有界/无界队列，同步移交阻塞队列

![image-20220310133523481](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310133523481.png)

![image-20220310133607074](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310133607074.png)

![image-20220310133730878](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310133730878.png)

![image-20220310133912161](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310133912161.png)

![image-20220310134029185](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310134029185.png)

![image-20220310134237323](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310134237323.png)

以上就是四种饱和策略

![image-20220310134914634](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310134914634.png)

![image-20220310135423895](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310135423895.png)

![image-20220310182802309](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310182802309.png)

![image-20220310182953590](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310182953590.png)

![image-20220310183053645](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310183053645.png)

![image-20220310183750053](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310183750053.png)

![image-20220310183840604](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310183840604.png)

![image-20220310184059557](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310184059557.png)

![image-20220310185332690](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310185332690.png)

![image-20220310185548026](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310185548026.png)

![image-20220310185618626](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310185618626.png)

![image-20220310185639781](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310185639781.png)

![image-20220310185748111](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310185748111.png)

![image-20220310185808944](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310185808944.png)

![image-20220310185836032](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310185836032.png)

![image-20220310185857062](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310185857062.png)

![image-20220310185921199](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310185921199.png)

![image-20220310190041310](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310190041310.png)

由上可以看出submit调用callable接口，有返回结果，不用抛异常，execute调用runnable接口，没返回结果，要抛异常

![image-20220310190349740](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310190349740.png)

![image-20220310190939206](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310190939206.png)

running线程池处在正常的运行状态中，能接收新任务，并且也能将任务添加到队列里，是正常的状态。当调用shutdown方法后，状态为shutdown，此时不再接受新任务，但是队列中的任务执行完毕。当调用shutdownNow方法后，状态为stop，不再接收新任务，丢弃队列中的任务，中断正在执行的任务（即立即什么事都不干了）。当stop和shutdown所有的任务关停后会进入TIDYING状态，表明所有的任务都已经中止。线程池内部调用terminated方法后，会进入TERMINATED状态，此时线程池已经彻底中止了。

![image-20220310192206668](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310192206668.png)

![image-20220310192238491](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310192238491.png)

![image-20220310192307135](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310192307135.png)

![image-20220310192329551](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310192329551.png)

![image-20220310192344957](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310192344957.png)

 ![image-20220310192405149](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310192405149.png)

![image-20220310192457829](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310192457829.png)

![image-20220310192512364](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310192512364.png)

![image-20220310192529029](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310192529029.png)

```java
package com.imooc.zhangxiaoxi.threadpool;

import org.junit.After;
import org.junit.Test;

import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

/**
 * 类名称：PolicyTest
 * ********************************
 * <p>
 * 类描述：饱和策略
 *
 * @author zhangxiaoxi
 * @date 上午10:15
 */
public class PolicyTest {

    /**
     * 线程池
     */
    private static ThreadPoolExecutor executor =
            new ThreadPoolExecutor(
                    // 核心线程数和最大线程数
                    2, 3,

                    // 线程空闲后的存活时间
                    60L, TimeUnit.SECONDS,

                    // 有界阻塞队列
                    new LinkedBlockingQueue<Runnable>(5));

    /**
     * 任务
     */
    class Task implements Runnable {
        /**
         * 任务名称
         */
        private String taskName;

        public Task(String taskName) {
            this.taskName = taskName;
        }

        @Override
        public void run() {
            System.out.println("线程[ " + Thread.currentThread().getName()
                    + " ]正在执行[ " + this.taskName + " ]任务...");

            try {
                Thread.sleep(1000L * 5);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

            System.out.println("线程[ " + Thread.currentThread().getName()
                    + " ]已执行完[ " + this.taskName + " ]任务！！！");
        }
    }

    /**
     * 线程池的执行过程
     *
     * 2个核心线程
     * 5个任务的队列
     * 3个最大线程：1个线程可用
     *
     * 前2个任务，会占用2个核心线程
     * 第3个到第7个任务，会暂存到任务队列中
     * 第8个任务，会启动最大线程，去执行
     * 第9个任务，没有线程可以去执行~~~
     */

    /**
     * 终止策略
     * TODO 抛出异常，拒绝任务提交
     */
    @Test
    public void abortPolicyTest() {
        // 设置饱和策略为 终止策略
        executor.setRejectedExecutionHandler(
                new ThreadPoolExecutor.AbortPolicy());

        for (int i = 1; i <= 10; i++) {
            try {
                // 提交10个线程任务
                executor.execute(new Task("线程任务" + i));
            } catch (Exception e) {
                System.err.println(e);
            }
        }

        // 关闭线程池
        executor.shutdown();
    }

    /**
     * 抛弃策略
     * TODO 直接丢弃掉新提交的任务
     */
    @Test
    public void discardPolicyTest() {
        // 设置饱和策略为 抛弃策略
        executor.setRejectedExecutionHandler(
                new ThreadPoolExecutor.DiscardPolicy());

        for (int i = 1; i <= 10; i++) {
            try {
                // 提交10个线程任务
                executor.execute(new Task("线程任务" + i));
            } catch (Exception e) {
                System.err.println(e);
            }
        }

        // 关闭线程池
        executor.shutdown();
    }

    /**
     * 抛弃旧任务策略
     * TODO 丢弃掉任务队列中的旧任务，暂存新提交的任务
     */
    @Test
    public void discardOldestPolicyTest() {
        // 设置饱和策略为 抛弃旧任务策略
        executor.setRejectedExecutionHandler(
                new ThreadPoolExecutor.DiscardOldestPolicy());

        for (int i = 1; i <= 10; i++) {
            try {
                // 提交10个线程任务
                executor.execute(new Task("线程任务" + i));
            } catch (Exception e) {
                System.err.println(e);
            }
        }

        // 关闭线程池
        executor.shutdown();
    }

    /**
     * 调用者运行策略
     * TODO 借用主线程来执行多余任务
     */
    @Test
    public void callerRunsPolicyTest() {
        // 设置饱和策略为 调用者运行策略
        executor.setRejectedExecutionHandler(
                new ThreadPoolExecutor.CallerRunsPolicy());

        for (int i = 1; i <= 10; i++) {
            try {
                // 提交10个线程任务
                executor.execute(new Task("线程任务" + i));
            } catch (Exception e) {
                System.err.println(e);
            }
        }

        // 关闭线程池
        executor.shutdown();
    }

    /**
     * 单元测试执行完，主线程等待100秒。防止主线程退出，看不到线程的执行结果
     * @throws InterruptedException
     */
    @After
    public void after() throws InterruptedException {
        Thread.sleep(1000L * 100);
    }

}

```

![image-20220310205447521](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310205447521.png)

![image-20220310205747728](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310205747728.png)

如何做到呢？看下源代码

![image-20220310205634208](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310205634208.png)

![image-20220310205829511](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310205829511.png)

![image-20220310210124873](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310210124873.png)

![image-20220310210326361](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310210326361.png)

![image-20220310210407180](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310210407180.png)

![image-20220310210513814](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310210513814.png)

![image-20220310210749302](C:\Users\kgliu\AppData\Roaming\Typora\typora-user-images\image-20220310210749302.png)